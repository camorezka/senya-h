
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Сеня — ИИ</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* Дизайн сохранен без изменений */
:root { --bg-dark:#05070a; --panel-bg:rgba(15,18,25,0.8); --accent-gradient:linear-gradient(135deg,#6366f1 0%,#a855f7 100%); --text-main:#f8fafc; --text-dim:#94a3b8; --glass-border:rgba(255,255,255,0.08); }
* { box-sizing:border-box;margin:0;padding:0;scrollbar-width:none; }
*::-webkit-scrollbar{display:none;}
body,html{height:100%;font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-dark);color:var(--text-main);overflow:hidden;}
body::before{content:"";position:absolute;width:500px;height:500px;background:radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%);top:-200px;left:-100px;pointer-events:none;}

#authOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-dark);z-index:9999;display:flex;align-items:center;justify-content:center;transition:0.5s;}
.auth-card{background:var(--panel-bg);padding:40px;border-radius:28px;border:1px solid var(--glass-border);text-align:center;width:340px;backdrop-filter:blur(20px);}
#googleLoginBtn{width:100%;padding:14px;border-radius:16px;border:none;background:#fff;color:#000;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:0.3s;}
#googleLoginBtn:hover{background:#6366f1;color:#fff;transform:translateY(-2px);}

.container{display:none;height:100vh;position:relative;z-index:1;}
.sidebar{width:320px;background:var(--panel-bg);backdrop-filter:blur(30px);padding:30px;display:flex;flex-direction:column;border-right:1px solid var(--glass-border);}
.sidebar h2{font-size:1.6rem;font-weight:800;margin-bottom:30px;letter-spacing:-0.5px;display:flex;align-items:center;gap:12px;}
.sidebar h2 i{background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
#newChatBtn{padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;gap:10px;transition:0.3s;margin-bottom:25px;}
#newChatBtn:hover{background:#fff;color:#000;transform:translateY(-2px);}
.chatList{flex:1;overflow-y:auto;}
.chatItem{padding:14px 18px;margin-bottom:10px;border-radius:14px;background:transparent;cursor:pointer;transition:0.2s;font-size:0.95rem;color:var(--text-dim);border:1px solid transparent;}
.chatItem:hover{background:rgba(255,255,255,0.05);color:#fff;}
.chatItem.active{background:rgba(99,102,241,0.1);border-color:rgba(99,102,241,0.3);color:#fff;}

.main{flex:1;display:flex;flex-direction:column;background:#080a0f;position:relative;align-items:center;}
#chat{flex:1;width:100%;max-width:850px;overflow-y:auto;display:flex;flex-direction:column;gap:25px;padding:40px 20px;scroll-behavior:smooth;}
.input-container{padding:30px 20px;max-width:850px;width:100%;}
.inputArea{display:flex;align-items:center;gap:15px;padding:10px 10px 10px 25px;background:rgba(20,25,35,0.6);backdrop-filter:blur(20px);border-radius:22px;border:1px solid var(--glass-border);transition:0.3s;}
#input{flex:1;padding:15px 0;border:none;background:transparent;color:#fff;font-size:1.1rem;outline:none;}
#send{width:52px;height:52px;border:none;border-radius:18px;background:#fff;color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.3s;}

.user-profile{display:flex;align-items:center;gap:12px;padding:15px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:20px;margin-bottom:20px;}
.avatar-box{width:42px;height:42px;border-radius:12px;background:var(--accent-gradient);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;color:white;}

.message { display: flex; flex-direction: column; margin-bottom: 15px; }
.message.user { align-self: flex-end; align-items: flex-end; }
.message.bot { align-self: flex-start; align-items: flex-start; }
.message-content { padding: 12px 18px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
.user .message-content { background: #6366f1; color: #fff; border-bottom-right-radius: 4px; }
.bot .message-content { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; }
</style>
<script type="importmap">
{
  "imports": {
    "express": "https://esm.sh/express@^5.2.1",
    "cors": "https://esm.sh/cors@^2.8.5",
    "express-session": "https://esm.sh/express-session@^1.18.2",
    "passport": "https://esm.sh/passport@^0.7.0",
    "passport-google-oauth20": "https://esm.sh/passport-google-oauth20@^2.0.0",
    "node-fetch": "https://esm.sh/node-fetch@^3.3.2"
  }
}
</script>
</head>
<body>
<div id="authOverlay">
<div class="auth-card">
<i class="fa-brands fa-google" style="font-size:3rem;color:#fff;margin-bottom:15px;"></i>
<h2 style="margin-bottom:10px;">Вход в Сеню</h2>
<p style="color:var(--text-dim);margin-bottom:25px;">Войди через Google, чтобы начать чат</p>
<button id="googleLoginBtn" onclick="googleLogin()">
<i class="fa-brands fa-google"></i> Войти через Google
</button>
<p style="font-size:0.75rem;color:var(--text-dim);margin-top:20px;">Безопасный вход через Google</p>
</div>
</div>
<div class="container" id="mainContainer">
<div class="sidebar">
<div class="user-profile">
<div class="avatar-box" id="userAvatar">?</div>
<div>
<div id="userName" style="font-weight:700;font-size:0.95rem;">Гость</div>
<div style="font-size:0.75rem;color:var(--text-dim);">Статус: Online</div>
</div>
</div>
<h2><i class="fa-solid fa-wand-sparkles"></i> Сеня</h2>
<button id="newChatBtn" class="sideBtn"><i class="fa-solid fa-plus"></i> Новый диалог</button>
<div class="chatList" id="chatList"></div>
</div>
<div class="main">
  <div id="chat"></div>
  <div class="input-container">
    <div class="inputArea">
      <input id="input" placeholder="Просто начни печатать..." autocomplete="off">
      <button id="send"><i class="fa-solid fa-arrow-up"></i></button>
    </div>
  </div>
</div>
</div>
<script>
const BACKEND_URL = 'https://senya-py.onrender.com';
let chats = JSON.parse(localStorage.getItem('senya_chats')) || {};
let activeChat = null;
let isGenerating = false;

const chatDiv = document.getElementById('chat');
const chatList = document.getElementById('chatList');
const inputField = document.getElementById('input');

function createChat(){
const id = Date.now().toString();
chats[id] = [];
chats[id].name = "Новый диалог";
activeChat = id;
renderChats(); renderChat(); inputField.focus();
}

function renderChats(){ chatList.innerHTML=''; Object.keys(chats).reverse().forEach(id=>{
const d=document.createElement('div');
d.className='chatItem'+(id===activeChat?' active':'');
d.innerHTML=`<i class="fa-regular fa-comment-dots" style="margin-right:10px"></i>${chats[id].name}`;
d.onclick=()=>{activeChat=id;renderChats();renderChat();};
chatList.appendChild(d);
}); }

function renderChat(){ chatDiv.innerHTML=''; if(!activeChat) return; chats[activeChat].forEach(m=>addMessage(m.text,m.type)); }

function addMessage(text,type){
const d=document.createElement('div'); d.className='message '+type;
const contentDiv=document.createElement('div'); contentDiv.className='message-content';
contentDiv.innerHTML=marked.parse ? marked.parse(text) : text; d.appendChild(contentDiv); chatDiv.appendChild(d); chatDiv.scrollTop=chatDiv.scrollHeight;
}

async function sendMessage(){
if(isGenerating||!inputField.value.trim()) return;
if(!activeChat) createChat();
const text=inputField.value; inputField.value=''; chats[activeChat].push({text,type:'user'}); addMessage(text,'user');
isGenerating=true;

try {
const r = await fetch(`${BACKEND_URL}/chat`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
const d = await r.json();
const answer=d.answer||"Ошибка сервера"; 
chats[activeChat].push({text:answer,type:'bot'}); addMessage(answer,'bot'); 
localStorage.setItem('senya_chats',JSON.stringify(chats));
} catch(e) {
addMessage("Сеня сейчас отдыхает.","bot");
} finally {
isGenerating=false;
}
}

document.getElementById('send').onclick=sendMessage;
inputField.onkeydown=e=>{if(e.key==='Enter') sendMessage();};
document.getElementById('newChatBtn').onclick=createChat;

async function checkUser(){
try{
const res=await fetch(`${BACKEND_URL}/me`,{credentials:'include'});
const user=await res.json();
const overlay=document.getElementById('authOverlay');
if(user && user.name){
document.getElementById('mainContainer').style.display='flex';
overlay.style.opacity='0';
setTimeout(()=>overlay.style.display='none',500);
document.getElementById('userName').innerText=user.name;
document.getElementById('userAvatar').innerText=user.name[0].toUpperCase();
}else{ overlay.style.display='flex'; overlay.style.opacity='1'; }
}catch(e){ console.error(e); }
}

window.addEventListener('DOMContentLoaded',async()=>{
const params=new URLSearchParams(window.location.search);
if(params.get('login')==='success'){ history.replaceState(null,'',window.location.pathname); }
renderChats();
await checkUser();
});

function googleLogin(){ window.location.href=`${BACKEND_URL}/auth/google`; }
</script>
</body>
</html>
