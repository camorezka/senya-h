
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сеня — ИИ</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #05070a;
            --panel-bg: rgba(15, 18, 25, 0.8);
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --shine-gradient: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #6366f1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-width: none; -webkit-tap-highlight-color: transparent; }
        *::-webkit-scrollbar { display: none; }

        body, html { height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        body::before { content: ""; position: absolute; width: 500px; height: 500px; background: radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%); top: -200px; left: -100px; pointer-events: none; }

        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.5s opacity ease; }
        .auth-card { background: var(--panel-bg); padding: 40px; border-radius: 28px; border: 1px solid var(--glass-border); text-align: center; width: 340px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }

        #googleLoginBtn { width: 100%; padding: 14px; border-radius: 16px; border: none; background: #fff; color: #000; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; margin-top: 20px; }
        #googleLoginBtn:hover { background: #6366f1; color: #fff; transform: translateY(-2px); }

        .container { display: none; height: 100vh; position: relative; z-index: 1; width: 100%; }
        .sidebar { width: 320px; background: var(--panel-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); padding: 30px; display: flex; flex-direction: column; border-right: 1px solid var(--glass-border); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        .sidebar h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 30px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .sidebar h2 i { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        #newChatBtn { padding: 14px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; margin-bottom: 25px; }
        #newChatBtn:hover { background: #fff; color: #000; transform: translateY(-2px); }

        .chatList { flex: 1; overflow-y: auto; }
        .chatItem { padding: 14px 18px; margin-bottom: 10px; border-radius: 14px; background: transparent; cursor: pointer; transition: 0.2s; font-size: 0.95rem; color: var(--text-dim); border: 1px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chatItem:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .chatItem.active { background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); color: #fff; }

        .main { flex: 1; display: flex; flex-direction: column; background: #080a0f; position: relative; align-items: center; overflow: hidden; }
        #chat { flex: 1; width: 100%; max-width: 850px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; padding: 40px 20px; scroll-behavior: smooth; }

        @keyframes messageSlide { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .message { width: fit-content; max-width: 75%; padding: 12px 18px; border-radius: 24px; line-height: 1.6; display: flex; flex-direction: column; justify-content: center; font-size: 1rem; animation: messageSlide 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; word-wrap: break-word; position: relative; }
        .user { align-self: flex-end; background: var(--accent-gradient); color: white; margin-left: auto; border-bottom-right-radius: 6px; box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4); }
        .bot { align-self: flex-start; background: var(--panel-bg); margin-right: auto; border: 1px solid var(--glass-border); border-bottom-left-radius: 6px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        .char { display: inline; opacity: 0; filter: blur(8px); animation: charIn 0.3s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; white-space: normal; }
        .typing.char { visibility: hidden; }
        @keyframes charIn { to { opacity: 1; visibility: visible; filter: blur(0); } }

        #empty { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; pointer-events: none; }
        #empty i { font-size: 5rem; margin-bottom: 25px; display: inline-block; background: var(--shine-gradient); background-size: 300% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shineAnim 4s linear infinite; filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.5)); }
        #empty div { font-size: 3.2rem; font-weight: 800; letter-spacing: -1.5px; background: var(--shine-gradient); background-size: 300% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shineAnim 4s linear infinite; }

        @keyframes shineAnim { 0% {background-position: 0% center;} 100% {background-position: 300% center;} }

        .input-container { padding: 30px 20px; max-width: 850px; width: 100%; }
        .inputArea { display: flex; align-items: center; gap: 15px; padding: 10px 10px 10px 25px; background: rgba(20, 25, 35, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 22px; border: 1px solid var(--glass-border); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .inputArea:focus-within { border-color: #6366f1; background: rgba(25, 30, 45, 0.8); transform: translateY(-2px); box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.5); }
        #input { flex: 1; padding: 15px 0; border: none; background: transparent; color: #fff; font-size: 1.1rem; outline: none; }
        #send { width: 52px; height: 52px; border: none; border-radius: 18px; background: #fff; color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        #send:hover { transform: scale(1.05) rotate(5deg); background: #6366f1; color: #fff; }

        .copy-btn { align-self: flex-start; margin-top: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-dim); padding: 6px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
        .copy-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

        .mobile-header { display: none; width: 100%; padding: 15px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--glass-border); align-items: center; justify-content: space-between; z-index: 50; }
        .menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        .user-profile { display: flex; align-items: center; gap: 12px; padding: 15px; background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); border-radius: 20px; margin-bottom: 20px; }
        .avatar-box { width: 42px; height: 42px; border-radius: 12px; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: white; overflow: hidden; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        @media(max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 1000; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); box-shadow: 20px 0 50px rgba(0,0,0,0.8); }
            #empty div { font-size: 1.8rem; }
            #empty i { font-size: 3.5rem; }
            .message { max-width: 90%; }
        }

        #loadingText { color: var(--text-dim); font-size: 0.9rem; margin-top: 15px; display: none; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-card">
            <i class="fa-brands fa-google" id="authIcon" style="font-size: 4rem; color: #fff; margin-bottom: 15px;"></i>
            <h2 id="authTitle" style="margin-bottom:10px; font-size: 1.8rem;">Вход в Сеню</h2>
            <p id="authDesc" style="color:var(--text-dim); margin-bottom:25px;">Войди через Google, чтобы начать чат</p>
            <button id="googleLoginBtn" onclick="googleLogin()">
                <i class="fa-brands fa-google"></i> Войти через Google
            </button>
            <div id="loadingText">Проверка авторизации...</div>
        </div>
    </div>

    <div class="container" id="app">
        <div class="mobile-header">
            <button class="menu-btn" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
            <div style="font-weight: 800; background: var(--shine-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.4rem;">Сеня</div>
            <div style="width: 24px;"></div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="user-profile">
                <div class="avatar-box" id="userAvatar">?</div>
                <div>
                    <div id="userName" style="font-weight: 700; font-size: 0.95rem;">Гость</div>
                    <div style="font-size: 0.75rem; color: var(--text-dim);">Статус: Online</div>
                </div>
            </div>
            <h2><i class="fa-solid fa-wand-sparkles"></i> Сеня</h2>
            <button id="newChatBtn"><i class="fa-solid fa-plus"></i> Новый диалог</button>
            <div class="chatList" id="chatList"></div>
        </div>
        <div class="main">
            <div id="chat"></div>
            <div id="empty">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <div>О чем поболтаем?</div>
            </div>
            <div class="input-container">
                <div class="inputArea">
                    <input id="input" placeholder="Просто начни печатать..." autocomplete="off">
                    <button id="send"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://senya-py.onrender.com';
        let chats = JSON.parse(localStorage.getItem('senya_chats')) || {};
        let activeChat = null;
        let isGenerating = false;
        const userId = Math.random().toString(36).slice(2);

        marked.setOptions({
            highlight: (code) => hljs.highlightAuto(code).value,
            breaks: true
        });

        const chatDiv = document.getElementById('chat');
        const chatList = document.getElementById('chatList');
        const empty = document.getElementById('empty');
        const inputField = document.getElementById('input');
        const sidebar = document.getElementById('sidebar');

        const audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        function playBeep(freq=440, dur=0.1, vol=1) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol * 0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + dur);
            } catch(e) {}
        }

        const sounds = {
            click: () => playBeep(600, 0.1, 0.5),
            send: () => playBeep(800, 0.15, 0.7),
            receive: () => playBeep(400, 0.2, 0.5),
            error: () => playBeep(150, 0.3, 1.0)
        };

        function updateEmptyMessage() {
            empty.style.display = (!activeChat || (chats[activeChat] && chats[activeChat].length === 0)) ? 'block' : 'none';
        }

        function createChat() {
            sounds.click();
            const id = Date.now().toString();
            chats[id] = [];
            chats[id].name = "Новый диалог";
            activeChat = id;
            renderChats();
            renderChat();
            inputField.focus();
            if(window.innerWidth <= 768) sidebar.classList.remove('open');
        }

        function renderChats() {
            chatList.innerHTML = '';
            Object.keys(chats).reverse().forEach(id => {
                const d = document.createElement('div');
                d.className = 'chatItem' + (id === activeChat ? ' active' : '');
                d.innerHTML = `<i class="fa-regular fa-comment-dots" style="margin-right:10px"></i>${chats[id].name}`;
                d.onclick = () => {
                    sounds.click();
                    activeChat = id;
                    renderChats();
                    renderChat();
                    if(window.innerWidth <= 768) sidebar.classList.remove('open');
                };
                chatList.appendChild(d);
            });
        }

        function renderChat() {
            chatDiv.innerHTML = '';
            if (!activeChat) { updateEmptyMessage(); return; }
            chats[activeChat].forEach(m => addMessage(m.text, m.type, false));
            updateEmptyMessage();
        }

        function addMessage(text, type, animate=true) {
            const d = document.createElement('div');
            d.className = 'message ' + type;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (type === 'bot' && animate) {
                contentDiv.classList.add('typing');
                contentDiv.innerHTML = marked.parse(text.trim());
                const speed = text.length > 500 ? 1 : (text.length > 200 ? 4 : 12);
                const walker = document.createTreeWalker(contentDiv, NodeFilter.SHOW_TEXT, null, false);
                let n, i = 0, nodes = [];
                while (n = walker.nextNode()) nodes.push(n);
                
                nodes.forEach(node => {
                    let textVal = node.textContent;
                    let parent = node.parentNode;
                    let span = document.createElement('span');
                    span.innerHTML = textVal.split('').map(c => {
                        return `<span class="char" style="animation-delay:${i++ * speed}ms">${c === ' ' ? '&nbsp;' : c}</span>`;
                    }).join('');
                    parent.replaceChild(span, node);
                });

                setTimeout(() => {
                    contentDiv.classList.remove('typing');
                }, i * speed + 500);
            } else {
                contentDiv.innerHTML = marked.parse(text.trim());
            }

            d.appendChild(contentDiv);

            if (type === 'bot') {
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerHTML = '<i class="fa-regular fa-copy"></i> Копировать';
                btn.onclick = () => {
                    navigator.clipboard.writeText(text);
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Готово';
                    setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Копировать', 2000);
                    sounds.click();
                };
                d.appendChild(btn);
            }

            d.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            chatDiv.appendChild(d);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            updateEmptyMessage();
        }

        async function sendMessage() {
            if (isGenerating || !inputField.value.trim()) return;
            sounds.send();
            if (!activeChat) createChat();
            const text = inputField.value;
            inputField.value = '';
            chats[activeChat].push({text, type: 'user'});
            
            if (chats[activeChat].length === 1) {
                chats[activeChat].name = text.substring(0, 22) + (text.length > 22 ? "..." : "");
                renderChats();
            }
            
            addMessage(text, 'user');
            isGenerating = true;

            try {
                const r = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, text })
                });
                const d = await r.json();
                sounds.receive();
                const answer = d.answer || "Ошибка сервера";
                chats[activeChat].push({text: answer, type: 'bot'});
                addMessage(answer, 'bot');
                localStorage.setItem('senya_chats', JSON.stringify(chats));
            } catch(e) {
                sounds.error();
                addMessage("Сеня сейчас отдыхает. Попробуй позже.", "bot");
            } finally {
                isGenerating = false;
            }
        }

        document.getElementById('send').onclick = sendMessage;
        inputField.onkeydown = e => { if (e.key === 'Enter') sendMessage(); };
        document.getElementById('newChatBtn').onclick = createChat;
        document.getElementById('menuToggle').onclick = () => {
            sidebar.classList.toggle('open');
            sounds.click();
        };

        async function checkUser() {
            const loading = document.getElementById('loadingText');
            loading.style.display = 'block';
            try {
                const res = await fetch(`${BACKEND_URL}/me`, { credentials: 'include' });
                if (!res.ok) throw new Error("Unauthorized");
                const user = await res.json();
                const overlay = document.getElementById('authOverlay');
                if (user && user.name) {
                    document.getElementById('app').style.display = 'flex';
                    overlay.style.opacity = '0';
                    overlay.style.pointerEvents = 'none';
                    setTimeout(() => overlay.style.display = 'none', 500);
                    document.getElementById('userName').innerText = user.name;
                    if(user.avatar) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${user.avatar}" alt="${user.name}">`;
                    } else {
                        document.getElementById('userAvatar').innerText = user.name[0].toUpperCase();
                    }
                }
            } catch(e) { 
                console.log("Not logged in");
                loading.style.display = 'none';
            }
        }

        function googleLogin() { 
            sounds.click();
            window.location.href = `${BACKEND_URL}/auth/google`; 
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('login') === 'success') { 
                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(checkUser, 300);
            } else {
                checkUser();
            }
            renderChats();
        });
    </script>
</body>
</html>
