<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Сеня — ИИ</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --base-dark: #02040a;
            --accent-primary: #6366f1;
            --accent-secondary: #a855f7;
            --accent-tertiary: #ec4899;
            --glass-bg: rgba(13, 17, 23, 0.7);
            --glass-border: rgba(255, 255, 255, 0.12);
            --user-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --bot-gradient: linear-gradient(160deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        *::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body, html { height: 100%; width: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--base-dark); color: var(--text-main); overflow: hidden; position: fixed; }

        .universe-bg { position: fixed; inset: 0; z-index: -2; background: radial-gradient(circle at 50% 50%, #0f172a 0%, #02040a 100%); overflow: hidden; }
        .nebula {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background: radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 40%), radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.1) 0%, transparent 40%), radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
            filter: blur(80px); animation: floatNebula 40s ease-in-out infinite alternate;
        }
        @keyframes floatNebula {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            50% { transform: translate(-5%, 5%) rotate(5deg) scale(1.1); }
            100% { transform: translate(5%, -2%) rotate(-5deg) scale(1); }
        }

        #starfield { position: fixed; top: 0; left: 0; z-index: -1; pointer-events: none; }

        #authOverlay { position: fixed; inset: 0; z-index: 10000; background: var(--base-dark); display: flex; align-items: center; justify-content: center; transition: opacity 0.6s ease; }
        .auth-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); backdrop-filter: blur(40px); padding: 60px 40px; border-radius: 40px; text-align: center; width: 85%; max-width: 440px; box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8); }

        .app-shell { display: flex; height: 100dvh; width: 100vw; position: relative; }
        .sidebar { width: 320px; background: rgba(10, 14, 23, 0.85); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; padding: 25px; transition: transform 0.5s cubic-bezier(0.33, 1, 0.68, 1); z-index: 2000; }
        
        .profile-section { background: rgba(255, 255, 255, 0.04); border-radius: 24px; padding: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 30px; border: 1px solid var(--glass-border); }
        .avatar { width: 50px; height: 50px; border-radius: 16px; background: var(--user-gradient); display: grid; place-items: center; font-weight: 800; overflow: hidden; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        #btn-new-chat { background: white; color: black; border: none; padding: 18px; border-radius: 20px; font-weight: 800; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1); transition: 0.3s; }

        .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-tab { padding: 14px 18px; border-radius: 18px; background: rgba(255, 255, 255, 0.02); border: 1px solid transparent; cursor: pointer; transition: 0.3s; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .chat-tab.active { background: rgba(99, 102, 241, 0.15); border-color: var(--accent-primary); color: white; }

        .main-stage { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #mobile-nav { display: none; position: absolute; top: 20px; left: 20px; z-index: 1500; background: var(--user-gradient); width: 50px; height: 50px; border-radius: 15px; border: none; color: white; font-size: 1.2rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }

        #chat-scroller { flex: 1; overflow-y: auto; padding: 100px 20px 180px; scroll-behavior: smooth; }
        .chat-container { max-width: 900px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; gap: 35px; }

        .msg-group { display: flex; flex-direction: column; width: 100%; animation: msgShow 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
        @keyframes msgShow { from { opacity: 0; transform: translateY(40px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .msg-group.user { align-items: flex-end; }
        .msg-group.bot { align-items: flex-start; }

        .bubble { padding: 20px 26px; border-radius: 30px; font-size: 1.05rem; line-height: 1.7; position: relative; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); max-width: 88%; }
        .user .bubble { background: var(--user-gradient); color: white; border-bottom-right-radius: 4px; }
        .bot .bubble { background: var(--bot-gradient); border: 1px solid var(--glass-border); border-left: 5px solid var(--accent-primary); color: #e2e8f0; border-bottom-left-radius: 4px; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.1); }

        .input-zone { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px 20px calc(20px + var(--safe-bottom)); background: linear-gradient(0deg, var(--base-dark) 40%, transparent); z-index: 1000; }
        .input-pill { max-width: 900px; margin: 0 auto; background: rgba(25, 30, 45, 0.8); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 30px; padding: 8px 10px 8px 25px; display: flex; align-items: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
        #user-input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 1.1rem; height: 54px; }
        #send-btn { width: 54px; height: 54px; background: white; border: none; border-radius: 22px; color: black; cursor: pointer; transition: 0.3s; }
        #send-btn:active { transform: scale(0.9); }

        #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0.8; }
        .glow-icon { font-size: 5rem; background: var(--user-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 10px 20px rgba(99, 102, 241, 0.4)); margin-bottom: 25px; }

        /* Таблицы бота */
        .bot .bubble table { width: 100% !important; border-collapse: separate !important; border-spacing: 0 !important; margin: 20px 0 !important; border: 1px solid rgba(99, 102, 241, 0.4) !important; border-radius: 12px !important; overflow: hidden !important; background: rgba(10, 14, 23, 0.8) !important; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4) !important; }
        .bot .bubble th { background: linear-gradient(180deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.05)) !important; color: #818cf8 !important; font-weight: 700 !important; text-transform: uppercase !important; font-size: 0.75rem !important; letter-spacing: 1px !important; padding: 15px !important; border-bottom: 1px solid rgba(99, 102, 241, 0.4) !important; }
        .bot .bubble td { padding: 12px 15px !important; color: #e2e8f0 !important; border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; font-size: 0.9rem !important; background: rgba(255, 255, 255, 0.02) !important; }
        .table-container-new { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; margin: 15px 0; }

        @media (max-width: 768px) {
            #mobile-nav { display: block; }
            .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; width: 80%; max-width: 85%; box-shadow: 50px 0 100px rgba(0, 0, 0, 0.9); }
            .sidebar.open { transform: translateX(100%); }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 1900; backdrop-filter: blur(4px); }
            .overlay.show { display: block; }
            .bubble { max-width: 95%; padding: 16px 20px; font-size: 1rem; }
        }

        #senya-info-page {
            position: fixed; inset: 0; z-index: 10001; background: var(--base-dark); 
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 80px 20px; overflow-y: auto; text-align: center;
            opacity: 0; transform: translateY(30px);
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #senya-info-page.active { display: flex; opacity: 1; transform: translateY(0); }
        
        .section-title {
            font-size: 2.2rem; font-weight: 800; margin-bottom: 20px;
            background: var(--user-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .info-content { max-width: 800px; width: 100%; }
        .info-divider { height: 1px; width: 100%; background: linear-gradient(90deg, transparent, var(--accent-primary), transparent); margin: 50px 0; }
        .close-info { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.1); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 10; }
        .hidden { display: none !important; }
    </style>
</head>

<body>
    <div class="universe-bg"><div class="nebula"></div></div>
    <canvas id="starfield"></canvas>

    <div id="senya-info-page">
        <div class="nebula" style="opacity: 0.3;"></div>
        <button class="close-info" onclick="toggleSenyaInfo()"><i class="fa-solid fa-xmark"></i></button>
        
        <div class="info-content">
            <h2 class="section-title">Сеня</h2>
            <p style="font-size: 1.1rem; line-height: 1.8; color: #e2e8f0;">
                <i><b>Сеня</b> — идеальный ИИ‑ассистент для новых возможностей, объединяющий передовые технологии обработки естественного языка и контекстного анализа. Он ориентирован на быстрый и точный ответ, предоставляя информацию в лаконичном и профессиональном виде.
                Основные возможности: генерация текстов и справочных материалов, адаптация к различным тематикам, краткие объяснения терминов только при необходимости. 
                Цель Сени — экономить ваше время, предоставляя готовые ответы, примеры и рекомендации, которые легко интегрировать в работу или проект.</i>
            </p>

            <div class="info-divider"></div>

            <h2 class="section-title">Разработчик</h2>
            <p style="font-size: 1.1rem; line-height: 1.8; color: #e2e8f0;">
                <b>Юрий (ник crown)</b> — человек, начинающий в области искусственного интеллекта и обработки естественного языка. Он сочетает глубокие теоретические знания (нейронные сети, трансформеры, контекстуальное обучение) с фантазией и реализацией проектов.
                Его опыт включает Python, HTML, CSS, JavaScript, Node.js.
                Цель — создать универсального помощника, который экономит время, повышает продуктивность и делает сложные технические задачи доступными для широкой аудитории. Именно эти идеи лежат в основе всех решений, реализованных в Сеня.
            </p>
        </div>
    </div>

    <div id="authOverlay">
        <div class="auth-card">
            <i class="fa-solid fa-sparkles glow-icon"></i>
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 10px;">Сеня</h1>
            <p style="color: var(--text-muted); margin-bottom: 40px;">Технологии будущего в твоих руках!</p>
            <div id="g_id_onload" data-client_id="68632825614-tfjkfpe616jrcfjl02l0k5gd8ar25jbj.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false" data-ux_mode="popup"></div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_black" data-size="large"></div>
        </div>
    </div>

    <div class="overlay" id="uiOverlay" onclick="toggleSidebar()"></div>
    <button id="mobile-nav" onclick="toggleSidebar()"><i class="fa-solid fa-bars-staggered"></i></button>

    <div class="app-shell">
        <aside class="sidebar" id="sidebar">
            <div class="profile-section">
                <div class="avatar" id="u-avatar">?</div>
                <div style="flex:1; overflow:hidden;">
                    <div id="u-name" style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Загрузка...</div>
                    <div style="font-size:0.7rem; color:#10b981; font-weight:800; text-transform:uppercase;">• online</div>
                </div>
                <button onclick="toggleSenyaInfo()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-right: 10px;"><i class="fa-solid fa-circle-info"></i></button>
                <button onclick="logout()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
            </div>
            <button id="btn-new-chat" onclick="createNewChat()"><i class="fa-solid fa-plus-circle"></i> Новый чат</button>
            <div class="history-list" id="chat-list"></div>
        </aside>

        <main class="main-stage">
            <div id="empty-state">
                <i class="fa-solid fa-wand-magic-sparkles glow-icon"></i>
                <h2 style="font-size: 1.8rem; font-weight: 800;">О чём пообщаемся? :3</h2>
            </div>
            <div id="chat-scroller"><div class="chat-container" id="chat-window"></div></div>
            <div class="input-zone">
                <div class="input-pill">
                    <input type="text" id="user-input" placeholder="Спросите что-нибудь..." autocomplete="off">
                    <button id="send-btn" onclick="handleSend()"><i class="fa-solid fa-arrow-up-long"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script>
        function toggleSenyaInfo() {
            const page = document.getElementById('senya-info-page');
            if (page.style.display === 'flex') {
                page.classList.remove('active');
                setTimeout(() => page.style.display = 'none', 500);
            } else {
                page.style.display = 'flex';
                setTimeout(() => page.classList.add('active'), 10);
            }
        }

        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStarfield() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 120; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5, opacity: Math.random(), speed: Math.random() * 0.05 });
            }
        }
        function animateStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; ctx.fill();
                s.y -= s.speed; if (s.y < 0) s.y = canvas.height;
            });
            requestAnimationFrame(animateStars);
        }
        window.addEventListener('resize', initStarfield); initStarfield(); animateStars();


        const BACKEND_URL = "https://senya-py.onrender.com";
        let chats = JSON.parse(localStorage.getItem('senya_v5_chats')) || {};
        let activeId = localStorage.getItem('activeChatId') || 'default';
        let isThinking = false;

        const renderer = new marked.Renderer();
        renderer.table = (header, body) => `<div class="table-wrapper"><table><thead>${header}</thead><tbody>${body}</tbody></table></div>`;
        marked.setOptions({ renderer, breaks: true, gfm: true });

        function removeEmojis(text) { return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}]/gu, ''); }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('uiOverlay');
            sb.classList.toggle('open'); ov.classList.toggle('show');
        }

        async function handleCredentialResponse(response) {
            const res = await fetch(`${BACKEND_URL}/auth/google`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: response.credential }) });
            const data = await res.json();
            if (data.success) {
                localStorage.setItem('jwtToken', data.jwtToken);
                localStorage.setItem('userName', data.user.name);
                localStorage.setItem('userPic', data.user.picture);
                startApp();
            }
        }

        function startApp() {
            document.getElementById('authOverlay').style.opacity = '0';
            setTimeout(() => document.getElementById('authOverlay').classList.add('hidden'), 600);
            document.getElementById('u-name').innerText = localStorage.getItem('userName');
            const pic = localStorage.getItem('userPic');
            if (pic) document.getElementById('u-avatar').innerHTML = `<img src="${pic}">`;
            renderSidebar();
            if (activeId !== 'default' && chats[activeId]) switchChat(activeId);
        }

        function renderSidebar() {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            Object.keys(chats).sort().reverse().forEach(id => {
                const item = document.createElement('div');
                item.className = `chat-tab ${id === activeId ? 'active' : ''}`;
                const title = chats[id][0]?.content || "Пустой диалог";
                item.innerHTML = `<i class="fa-regular fa-message" style="margin-right:10px"></i> ${title}`;
                item.onclick = () => { switchChat(id); if (window.innerWidth <= 768) toggleSidebar(); };
                list.appendChild(item);
            });
        }

        function switchChat(id) {
            activeId = id; localStorage.setItem('activeChatId', id);
            const win = document.getElementById('chat-window'); win.innerHTML = '';
            const messages = chats[id] || [];
            document.getElementById('empty-state').classList.toggle('hidden', messages.length > 0);
            messages.forEach(m => appendUI(m.role, m.content));
            renderSidebar();
        }

        function createNewChat() { activeId = 'ch_' + Date.now(); chats[activeId] = []; switchChat(activeId); }

        function normalizeText(text) {
            if (!text) return '';
            if (typeof text === 'string') return text;
            return text.content || text.text || JSON.stringify(text);
        }

        function appendUI(role, text) {
            const win = document.getElementById('chat-window');
            document.getElementById('empty-state').classList.add('hidden');
            const group = document.createElement('div'); group.className = `msg-group ${role}`;
            const bubble = document.createElement('div'); bubble.className = 'bubble';
            let content = normalizeText(text);
            if (role === 'bot') {
                content = removeEmojis(content);
                content = content.replace(/((?:^\|.*\|\s*$\n?)+)/gm, (match) => {
                    const lines = match.trim().split('\n');
                    const header = lines[0].split('|').slice(1, -1).map(h => `<th>${h.trim()}</th>`).join('');
                    const rows = lines.slice(2).map(r => {
                        const cells = r.split('|').slice(1, -1).map(c => `<td>${c.trim()}</td>`).join('');
                        return `<tr>${cells}</tr>`;
                    }).join('');
                    return `<div class="table-container-new"><table><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div>`;
                });
            }
            bubble.innerHTML = marked.parse(content);
            group.appendChild(bubble); win.appendChild(group);
            document.getElementById('chat-scroller').scrollTop = win.scrollHeight;
            group.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if (!val || isThinking) return;
            isThinking = true; input.value = '';
            if (!chats[activeId]) chats[activeId] = [];
            chats[activeId].push({ role: 'user', content: val });
            appendUI('user', val);

            const loader = document.createElement('div');
            loader.className = 'msg-group bot';
            loader.innerHTML = `<div class="bubble" style="opacity:0.7"><i class="fa-solid fa-circle-notch fa-spin"></i> Сеня думает...</div>`;
            document.getElementById('chat-window').appendChild(loader);

            try {
                const res = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` },
                    body: JSON.stringify({ messages: chats[activeId] })
                });
                const data = await res.json();
                loader.remove();
                let reply = normalizeText(data.response);
                appendUI('bot', reply);
                chats[activeId].push({ role: 'bot', content: reply });
                localStorage.setItem('senya_v5_chats', JSON.stringify(chats));
                renderSidebar();
            } catch (e) { loader.remove(); appendUI('bot', "Ошибка связи."); } finally { isThinking = false; }
        }
        function logout() {
        
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userPic');
            localStorage.removeItem('activeChatId');
            
           
            
            window.location.reload();
        }

        document.getElementById('user-input').onkeydown = e => { if (e.key === 'Enter') handleSend(); };
        if (localStorage.getItem('jwtToken')) startApp();
    </script>
</body>
</html>
